<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi QR Code</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
    }
    #reader {
      width: 320px;
      margin: 20px auto;
      border: 2px solid #2c3e50;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #result {
      margin-top: 15px;
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px;
    }
    .success {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .error {
      color: #721c24;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #3498db;
      color: #fff;
      transition: 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <h1>Absensi QR Code</h1>
  <div id="reader"></div>
  <div id="result">Silakan scan QR Code...</div>
  <button onclick="restartScanner()">Scan Ulang</button>

  <script>
    // üîπ Ganti URL ini dengan URL googleusercontent.com hasil deploy
    const SCRIPT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjwhSMygVt3gthppTMZ6O3K7ZKbI4sfMGTnDei9ahJhBdUOYJa8fruyZ1qyWgoalfWT3uV0lEj8XDae24IG4R1BN2k9uDoQZlAfnTkqOWGv0XD366kUJSlOLSut6aw-oQWVQty8AKsGEtRZDORIOhYYWUYQ88N-xYguL6XcG-gzdmHUUI6sYXrS-bLkoaKuR3FKWSNGdRIS-IL76JlfX17ItSLF-7xHOvSw_9hCX_L3f51WW-stiP_K7d1V1MjG3WaNaaB1dqaDpWQVPj9Lper-w8XhSA&lib=MSUm486ebANF_sArvtUnSu4d8E7MbZZVT";

    let html5QrcodeScanner;

    function sendData(nim, nama = "") {
      fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nim: nim, nama: nama })
      })
      .then(r => r.json())
      .then(res => {
        document.getElementById("result").className = "success";
        document.getElementById("result").innerText = "‚úÖ Absen berhasil: " + nim;
      })
      .catch(err => {
        document.getElementById("result").className = "error";
        document.getElementById("result").innerText = "‚ùå Gagal kirim: " + err;
      });
    }

    function onScanSuccess(decodedText) {
      document.getElementById("result").className = "";
      document.getElementById("result").innerText = "QR Terdeteksi: " + decodedText;
      sendData(decodedText);

      // üî¥ Stop scanner setelah sukses 1x
      html5QrcodeScanner.stop().then(() => {
        console.log("Scanner dihentikan.");
      }).catch(err => console.error("Stop gagal:", err));
    }

    function startScanner() {
      html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      ).catch(err => {
        document.getElementById("result").className = "error";
        document.getElementById("result").innerText = "‚ùå Error: " + err;
      });
    }

    function restartScanner() {
      document.getElementById("result").className = "";
      document.getElementById("result").innerText = "Silakan scan QR Code...";
      startScanner();
    }

    // Mulai otomatis
    startScanner();
  </script>
</body>
</html>

